<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Supabase + Razorpay – Combined Test</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 520px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }
    h1 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    h2 { font-size: 1rem; color: #94a3b8; margin: 1.5rem 0 0.75rem; border-bottom: 1px solid #334155; padding-bottom: 0.25rem; }
    .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }
    .status { font-size: 0.875rem; color: #94a3b8; margin-bottom: 1rem; }
    .status.error { color: #f87171; }
    .status.success { color: #4ade80; }
    button {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    button:hover { background: #2563eb; }
    button.sign-out { background: #64748b; }
    button.sign-out:hover { background: #475569; }
    button.btn-pay { background: #059669; }
    button.btn-pay:hover { background: #047857; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .user-info { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #334155; }
    .user-info p { margin: 0.25rem 0; font-size: 0.9rem; }
    .user-info strong { color: #94a3b8; }
    img.avatar { width: 48px; height: 48px; border-radius: 50%; margin-bottom: 0.5rem; }
    .hidden { display: none; }
    label { display: block; margin-top: 0.75rem; margin-bottom: 0.25rem; font-weight: 600; color: #94a3b8; font-size: 0.9rem; }
    input { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #334155; border-radius: 8px; font-size: 1rem; background: #0f172a; color: #e2e8f0; }
    .help { font-size: 0.8rem; color: #64748b; margin-top: 0.2rem; }
    .result { margin-top: 1rem; padding: 0.75rem; border-radius: 8px; font-size: 0.9rem; }
    .result.success { background: #14532d; color: #86efac; }
    .result.error { background: #450a0a; color: #fca5a5; }
    .payments-list { font-size: 0.85rem; color: #94a3b8; max-height: 120px; overflow-y: auto; }
    .payments-list div { padding: 0.25rem 0; border-bottom: 1px solid #334155; }
    pre { font-size: 0.75rem; background: #0f172a; padding: 0.5rem; border-radius: 6px; overflow-x: auto; }
    .supabase-json { max-height: 180px; overflow: auto; white-space: pre-wrap; word-break: break-all; }
    .data-ok { color: #4ade80; }
    .data-err { color: #f87171; }
    .post-payment-card { border: 1px solid #059669; background: linear-gradient(180deg, #052e16 0%, #14532d 100%); }
    .post-payment-card .success-badge { display: inline-flex; align-items: center; gap: 0.5rem; color: #86efac; font-weight: 600; margin-bottom: 0.75rem; }
    .post-payment-card .success-badge svg { flex-shrink: 0; }
    .post-payment-card .detail { font-size: 0.9rem; margin: 0.35rem 0; color: #bbf7d0; }
    .post-payment-card .detail strong { color: #94a3b8; }
    .btn-secondary { background: #475569; }
    .btn-secondary:hover { background: #64748b; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Supabase + Razorpay – Combined Test</h1>
    <p class="status" id="status">Checking session…</p>

    <div id="signed-out">
      <button type="button" id="btn-google" aria-label="Sign in with Google">
        <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
        Sign in with Google
      </button>
    </div>

    <div id="signed-in" class="hidden">
      <div class="user-info">
        <img id="user-avatar" class="avatar" src="" alt="" />
        <p><strong>Email</strong> <span id="user-email"></span></p>
        <p><strong>Name</strong> <span id="user-name"></span></p>
        <p><strong>User ID</strong> <span id="user-id" style="word-break: break-all;"></span></p>
      </div>
      <button type="button" class="sign-out" id="btn-sign-out">Sign out</button>
    </div>
  </div>

  <!-- Post-payment success UI (shown after payment or when URL has #payment-success) -->
  <div class="card post-payment-card hidden" id="post-payment-card">
    <div class="success-badge">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
      Payment successful
    </div>
    <p class="detail"><strong>Order ID</strong> <span id="success-order-id">—</span></p>
    <p class="detail"><strong>Payment ID</strong> <span id="success-payment-id">—</span></p>
    <p class="detail"><strong>Amount</strong> <span id="success-amount">—</span></p>
    <p class="detail"><strong>Saved to Supabase</strong> <span id="success-saved">—</span></p>
    <button type="button" class="btn-secondary" id="btn-back-to-pay">Make another payment</button>
  </div>

  <div class="card" id="payment-card">
    <h2>Razorpay test payment</h2>
    <p class="help">Create an order first (see README or use <code>aoo-static-gh/scripts/create-razorpay-order.js</code>), then paste Order ID below. Use <strong>test</strong> keys.</p>

    <label for="rp-key">Key ID</label>
    <input id="rp-key" type="text" placeholder="rzp_test_xxxxxxxx" />

    <label for="rp-order">Order ID</label>
    <input id="rp-order" type="text" placeholder="order_xxxxxxxx" />

    <label for="rp-amount">Amount (paise)</label>
    <input id="rp-amount" type="number" placeholder="100" value="100" min="100" />

    <label for="rp-desc">Description (optional)</label>
    <input id="rp-desc" type="text" placeholder="Test payment" />

    <button type="button" class="btn-pay" id="rp-pay-btn" style="margin-top: 1rem;">Open Razorpay checkout</button>

    <div id="rp-result" class="result" style="display: none;" role="alert"></div>

    <div id="payments-from-db" class="hidden" style="margin-top: 1rem;">
      <h2 style="margin-top: 0;">Your payments (from Supabase)</h2>
      <div id="payments-list" class="payments-list"></div>
    </div>
  </div>

  <div class="card" id="supabase-check-card">
    <h2>Supabase data check</h2>
    <p class="help">Verify that data is saved and readable from Supabase. Sign in first, then click the button.</p>
    <button type="button" class="btn-secondary" id="btn-check-supabase" style="margin-bottom: 0.75rem;">Check if data is in Supabase</button>
    <div id="supabase-check-status" class="help" style="margin-bottom: 0.5rem;"></div>
    <div id="supabase-check-out" style="display: none;">
      <p class="detail" style="margin-top: 0.5rem;"><strong>auth_users</strong> <span id="supabase-auth-status"></span></p>
      <pre id="supabase-auth-json" class="supabase-json"></pre>
      <p class="detail" style="margin-top: 0.75rem;"><strong>payments</strong> <span id="supabase-payments-status"></span></p>
      <pre id="supabase-payments-json" class="supabase-json"></pre>
    </div>
    <div id="supabase-check-signout" class="help">Sign in with Google to check Supabase data.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="config.js"></script>
  <script>
    (function () {
      const statusEl = document.getElementById('status');
      const signedOut = document.getElementById('signed-out');
      const signedIn = document.getElementById('signed-in');
      const btnGoogle = document.getElementById('btn-google');
      const btnSignOut = document.getElementById('btn-sign-out');
      const paymentCard = document.getElementById('payment-card');
      const rpKey = document.getElementById('rp-key');
      const rpOrder = document.getElementById('rp-order');
      const rpAmount = document.getElementById('rp-amount');
      const rpDesc = document.getElementById('rp-desc');
      const rpPayBtn = document.getElementById('rp-pay-btn');
      const rpResult = document.getElementById('rp-result');
      const paymentsFromDb = document.getElementById('payments-from-db');
      const paymentsList = document.getElementById('payments-list');
      const postPaymentCard = document.getElementById('post-payment-card');
      const successOrderId = document.getElementById('success-order-id');
      const successPaymentId = document.getElementById('success-payment-id');
      const successAmount = document.getElementById('success-amount');
      const successSaved = document.getElementById('success-saved');
      const btnBackToPay = document.getElementById('btn-back-to-pay');
      const btnCheckSupabase = document.getElementById('btn-check-supabase');
      const supabaseCheckStatus = document.getElementById('supabase-check-status');
      const supabaseCheckOut = document.getElementById('supabase-check-out');
      const supabaseCheckSignout = document.getElementById('supabase-check-signout');
      const supabaseAuthStatus = document.getElementById('supabase-auth-status');
      const supabaseAuthJson = document.getElementById('supabase-auth-json');
      const supabasePaymentsStatus = document.getElementById('supabase-payments-status');
      const supabasePaymentsJson = document.getElementById('supabase-payments-json');

      const PAYMENT_SUCCESS_KEY = 'testBoth_lastPayment';

      let supabaseClient = null;
      let currentUser = null;

      function setStatus(msg, isError) {
        statusEl.textContent = msg;
        statusEl.className = 'status' + (isError ? ' error' : ' success');
      }

      function showUser(user) {
        signedOut.classList.add('hidden');
        signedIn.classList.remove('hidden');
        document.getElementById('user-email').textContent = user.email ?? '—';
        document.getElementById('user-name').textContent = user.user_metadata?.full_name ?? user.user_metadata?.name ?? '—';
        document.getElementById('user-id').textContent = user.id ?? '—';
        const img = document.getElementById('user-avatar');
        const url = user.user_metadata?.avatar_url ?? user.user_metadata?.picture;
        if (url) { img.src = url; img.alt = user.user_metadata?.full_name ?? 'Avatar'; img.style.display = ''; }
        else { img.style.display = 'none'; }
        currentUser = user;
      }

      function showSignedOut() {
        signedIn.classList.add('hidden');
        signedOut.classList.remove('hidden');
        setStatus('Signed out. Sign in to test payments linked to your account.');
        currentUser = null;
        paymentsFromDb.classList.add('hidden');
        supabaseCheckSignout.style.display = 'block';
        supabaseCheckOut.style.display = 'none';
        supabaseCheckStatus.textContent = '';
      }

      function showRpResult(message, isSuccess) {
        rpResult.textContent = message;
        rpResult.className = 'result ' + (isSuccess ? 'success' : 'error');
        rpResult.style.display = 'block';
      }

      function showPostPaymentUI(details) {
        if (!details) {
          try {
            var raw = sessionStorage.getItem(PAYMENT_SUCCESS_KEY);
            details = raw ? JSON.parse(raw) : null;
          } catch (e) { details = null; }
        }
        successOrderId.textContent = details && details.order_id ? details.order_id : '—';
        successPaymentId.textContent = details && details.payment_id ? details.payment_id : '—';
        successAmount.textContent = details && details.amount_paise != null ? details.amount_paise + ' paise (₹' + (details.amount_paise / 100).toFixed(2) + ')' : '—';
        successSaved.textContent = details && details.saved ? 'Yes' : '—';
        postPaymentCard.classList.remove('hidden');
        paymentCard.classList.add('hidden');
        if (window.location.hash !== '#payment-success') {
          window.history.replaceState(null, '', window.location.pathname + '#payment-success');
        }
        postPaymentCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function hidePostPaymentUI() {
        postPaymentCard.classList.add('hidden');
        paymentCard.classList.remove('hidden');
        if (window.location.hash === '#payment-success') {
          window.history.replaceState(null, '', window.location.pathname);
        }
        paymentCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      async function upsertUserToTable(client, user) {
        const { error } = await client.from('auth_users').upsert({
          id: user.id,
          email: user.email ?? '',
          full_name: user.user_metadata?.full_name ?? user.user_metadata?.name ?? null,
          avatar_url: user.user_metadata?.avatar_url ?? user.user_metadata?.picture ?? null,
          updated_at: new Date().toISOString()
        }, { onConflict: 'id' });
        if (error) console.warn('Could not save user to table:', error.message);
      }

      async function savePaymentToSupabase(client, userId, orderId, paymentId, amountPaise) {
        const { error } = await client.from('payments').insert({
          user_id: userId,
          razorpay_order_id: orderId,
          razorpay_payment_id: paymentId || null,
          amount_paise: amountPaise,
          currency: 'INR'
        });
        if (error) {
          console.warn('Could not save payment to Supabase (run supabase-table-setup.sql?):', error.message);
          return false;
        }
        return true;
      }

      async function loadPaymentsFromSupabase(client, userId) {
        const { data, error } = await client.from('payments').select('razorpay_order_id, razorpay_payment_id, amount_paise, created_at').eq('user_id', userId).order('created_at', { ascending: false }).limit(10);
        if (error || !data || data.length === 0) {
          paymentsFromDb.classList.add('hidden');
          return;
        }
        paymentsFromDb.classList.remove('hidden');
        paymentsList.innerHTML = data.map(function (p) {
          return '<div>Order: ' + p.razorpay_order_id + ' | Payment: ' + (p.razorpay_payment_id || '—') + ' | ' + p.amount_paise + ' paise | ' + new Date(p.created_at).toLocaleString() + '</div>';
        }).join('');
      }

      async function checkSupabaseData() {
        supabaseCheckStatus.textContent = 'Checking…';
        supabaseCheckOut.style.display = 'none';
        if (!supabaseClient || !currentUser) {
          supabaseCheckStatus.textContent = '';
          supabaseCheckSignout.style.display = 'block';
          return;
        }
        supabaseCheckSignout.style.display = 'none';
        supabaseCheckOut.style.display = 'block';

        var authStatusEl = supabaseAuthStatus;
        var authJsonEl = supabaseAuthJson;
        var payStatusEl = supabasePaymentsStatus;
        var payJsonEl = supabasePaymentsJson;

        var authRes = await supabaseClient.from('auth_users').select('*').eq('id', currentUser.id).maybeSingle();
        if (authRes.error) {
          authStatusEl.textContent = 'Error: ' + authRes.error.message;
          authStatusEl.className = 'data-err';
          authJsonEl.textContent = JSON.stringify({ error: authRes.error.message }, null, 2);
        } else if (authRes.data) {
          authStatusEl.textContent = '1 row (data is in Supabase)';
          authStatusEl.className = 'data-ok';
          authJsonEl.textContent = JSON.stringify(authRes.data, null, 2);
        } else {
          authStatusEl.textContent = 'No row (run supabase-table-setup.sql and sign in again)';
          authStatusEl.className = 'data-err';
          authJsonEl.textContent = 'null';
        }

        var payRes = await supabaseClient.from('payments').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(20);
        if (payRes.error) {
          payStatusEl.textContent = 'Error: ' + payRes.error.message;
          payStatusEl.className = 'data-err';
          payJsonEl.textContent = JSON.stringify({ error: payRes.error.message }, null, 2);
        } else {
          var count = payRes.data ? payRes.data.length : 0;
          payStatusEl.textContent = count + ' row(s)' + (count > 0 ? ' (data is in Supabase)' : ' — make a test payment to see data here');
          payStatusEl.className = count > 0 ? 'data-ok' : '';
          payJsonEl.textContent = JSON.stringify(payRes.data || [], null, 2);
        }

        supabaseCheckStatus.textContent = 'Done. Data above is what Supabase returned.';
      }

      async function init() {
        if (typeof CONFIG === 'undefined' || !CONFIG.SUPABASE_URL || !CONFIG.SUPABASE_ANON_KEY) {
          setStatus('Add SUPABASE_URL and SUPABASE_ANON_KEY in config.js.', true);
          return;
        }
        if (CONFIG.SUPABASE_URL.includes('YOUR_PROJECT') || CONFIG.SUPABASE_URL.includes('your_project')) {
          setStatus('Replace placeholder in config.js with your Supabase Project URL.', true);
          return;
        }

        const { createClient } = supabase;
        supabaseClient = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

        if (CONFIG.RAZORPAY_KEY_ID) {
          rpKey.value = CONFIG.RAZORPAY_KEY_ID;
        }

        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        if (sessionError) {
          setStatus('Session error: ' + sessionError.message, true);
          return;
        }
        if (session?.user) {
          setStatus('Signed in. You can test Razorpay below; successful payments are saved to Supabase.');
          showUser(session.user);
          supabaseCheckSignout.style.display = 'none';
          await upsertUserToTable(supabaseClient, session.user);
          await loadPaymentsFromSupabase(supabaseClient, session.user.id);
        } else {
          setStatus('Not signed in. Sign in with Google, then test Razorpay (payments will be linked to your user).');
          supabaseCheckSignout.style.display = 'block';
        }

        if (window.location.hash === '#payment-success') {
          showPostPaymentUI();
        }

        btnBackToPay.onclick = function () { hidePostPaymentUI(); };
        btnCheckSupabase.onclick = function () { checkSupabaseData(); };

        supabaseClient.auth.onAuthStateChange(async function (event, session) {
          if (event === 'SIGNED_IN' && session?.user) {
            setStatus('Signed in. You can test Razorpay below.');
            showUser(session.user);
            supabaseCheckSignout.style.display = 'none';
            await upsertUserToTable(supabaseClient, session.user);
            await loadPaymentsFromSupabase(supabaseClient, session.user.id);
          } else if (event === 'SIGNED_OUT') {
            showSignedOut();
          }
        });

        btnGoogle.onclick = async function () {
          setStatus('Redirecting to Google…');
          const redirectTo = window.location.origin + window.location.pathname;
          const { error } = await supabaseClient.auth.signInWithOAuth({ provider: 'google', options: { redirectTo } });
          if (error) setStatus('Error: ' + error.message, true);
        };

        btnSignOut.onclick = async function () {
          await supabaseClient.auth.signOut();
          showSignedOut();
        };

        rpPayBtn.addEventListener('click', function () {
          var key = (rpKey && rpKey.value) ? rpKey.value.trim() : '';
          var orderId = (rpOrder && rpOrder.value) ? rpOrder.value.trim() : '';
          var amount = rpAmount ? parseInt(rpAmount.value, 10) : 100;
          var description = (rpDesc && rpDesc.value) ? rpDesc.value.trim() : 'Test payment';

          rpResult.style.display = 'none';

          if (!key) {
            showRpResult('Please enter your Razorpay Key ID.', false);
            return;
          }
          if (!orderId) {
            showRpResult('Please enter an Order ID (create an order from backend/script first).', false);
            return;
          }
          if (isNaN(amount) || amount < 100) {
            showRpResult('Amount must be at least 100 paise.', false);
            return;
          }
          if (typeof Razorpay === 'undefined') {
            showRpResult('Razorpay script failed to load.', false);
            return;
          }

          var options = {
            key: key,
            order_id: orderId,
            amount: amount,
            currency: 'INR',
            description: description || 'Test payment',
            handler: function (response) {
              var msg = 'Payment success. payment_id: ' + (response.razorpay_payment_id || '') + ', order_id: ' + (response.razorpay_order_id || '');
              showRpResult(msg, true);
              if (supabaseClient && currentUser) {
                savePaymentToSupabase(supabaseClient, currentUser.id, response.razorpay_order_id, response.razorpay_payment_id, amount).then(function (saved) {
                  if (saved) loadPaymentsFromSupabase(supabaseClient, currentUser.id);
                  var details = { order_id: response.razorpay_order_id, payment_id: response.razorpay_payment_id, amount_paise: amount, saved: saved };
                  try { sessionStorage.setItem(PAYMENT_SUCCESS_KEY, JSON.stringify(details)); } catch (e) {}
                  showPostPaymentUI(details);
                });
              } else {
                var details = { order_id: response.razorpay_order_id, payment_id: response.razorpay_payment_id, amount_paise: amount, saved: false };
                try { sessionStorage.setItem(PAYMENT_SUCCESS_KEY, JSON.stringify(details)); } catch (e) {}
                showPostPaymentUI(details);
              }
            },
            modal: {
              ondismiss: function () {
                showRpResult('Checkout closed or payment failed.', false);
              }
            }
          };

          var rzp = new Razorpay(options);
          rzp.on('payment.failed', function (response) {
            showRpResult('Payment failed: ' + (response.error && response.error.description ? response.error.description : 'Unknown error'), false);
          });
          rzp.open();
        });
      }

      init();
    })();
  </script>
</body>
</html>
